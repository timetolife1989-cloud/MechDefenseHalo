name: Parallel PR Manager

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]

jobs:
  queue-manager:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    
    steps:
      - name: Check active PRs
        id: check_prs
        run: |
          echo "Checking active PR count..."
          
          # Get count of open PRs
          OPEN_PRS=$(gh pr list --repo ${{ github.repository }} --state open --json number --jq 'length')
          echo "open_prs=$OPEN_PRS" >> $GITHUB_OUTPUT
          
          echo "ðŸ“Š Active PRs: $OPEN_PRS / 20 max"
          
          if [ "$OPEN_PRS" -gt 20 ]; then
            echo "âš ï¸ Warning: More than 20 PRs open (${OPEN_PRS})"
            echo "Consider reviewing and merging existing PRs"
          else
            echo "âœ… PR count within limits"
          fi
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: PR Queue Summary
        run: |
          echo "## ðŸ“‹ PR Queue Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Active PRs:** ${{ steps.check_prs.outputs.open_prs }} / 20" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_prs.outputs.open_prs }}" -gt 20 ]; then
            echo "âš ï¸ **Status:** Over capacity" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Recommendation:** Review and merge pending PRs to free up queue" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.check_prs.outputs.open_prs }}" -gt 15 ]; then
            echo "ðŸŸ¡ **Status:** High capacity (${{ steps.check_prs.outputs.open_prs }}/20)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **Status:** Normal capacity" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** Each PR runs independently - no blocking between PRs" >> $GITHUB_STEP_SUMMARY

  # This job demonstrates independent execution
  # Each PR gets its own workflow run with no dependencies
  pr-processor:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    # Use concurrency to prevent resource exhaustion
    concurrency:
      group: pr-${{ github.event.pull_request.number }}
      cancel-in-progress: true
    
    if: github.event.pull_request
    
    steps:
      - name: Process PR
        run: |
          echo "Processing PR #${{ github.event.pull_request.number }}"
          echo "Branch: ${{ github.event.pull_request.head.ref }}"
          echo "Base: ${{ github.event.pull_request.base.ref }}"
          echo ""
          echo "âœ… PR processing initiated"
          echo "ðŸ”„ CI jobs will run independently"
          echo "ðŸš€ Auto-merge enabled on success"
      
      - name: Execution Strategy
        run: |
          echo "## ðŸ”§ Execution Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR Number:** #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Concurrency Group:** pr-${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Independent Execution:** âœ… Yes" >> $GITHUB_STEP_SUMMARY
          echo "**Blocking Other PRs:** âŒ No" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This PR runs in parallel with others - no queue waiting required." >> $GITHUB_STEP_SUMMARY
